<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Facebook Scraper - Network Spy Mode</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { 
      max-width: 900px; 
      margin: 0 auto 20px; 
      background: white; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
    }
    h2 { 
      text-align: center; 
      color: #2c3e50; 
      margin-bottom: 5px;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
      margin-bottom: 20px;
    }
    label { 
      font-weight: 600; 
      color: #34495e; 
      display: block;
      margin-bottom: 5px;
    }
    input, textarea, select { 
      width: 100%; 
      margin: 0 0 15px 0; 
      padding: 12px; 
      border: 2px solid #e0e0e0; 
      border-radius: 8px; 
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button { 
      width: 100%; 
      padding: 14px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      color: white; 
      font-weight: bold; 
      font-size: 15px;
      margin-bottom: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    button:active {
      transform: translateY(0);
    }
    .btn-login { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-search { background: linear-gradient(135deg, #2980b9, #3498db); }
    .btn-feed { background: linear-gradient(135deg, #e67e22, #f39c12); }
    .btn-newsfeed { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .btn-dashboard { 
      background: linear-gradient(135deg, #e74c3c, #c0392b); 
      font-size: 16px;
      padding: 16px;
      margin-top: 20px;
    }
    
    .loading { 
      display: none; 
      text-align: center; 
      color: #666; 
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .section-divider {
      display: flex;
      align-items: center;
      margin: 25px 0;
    }
    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      border-bottom: 2px dashed #e0e0e0;
    }
    .section-divider span {
      padding: 0 15px;
      color: #7f8c8d;
      font-weight: 600;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
    }
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 12px; 
      text-align: left; 
      vertical-align: top; 
    }
    th { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white;
    }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e8f4f8; }
    
    .thumb { 
      width: 100px; 
      height: 100px; 
      object-fit: cover; 
      border-radius: 8px; 
      background: #eee;
      border: 2px solid #e0e0e0;
    }
    .price { 
      color: #e74c3c; 
      font-weight: bold; 
      font-size: 1.1em; 
    }
    .author {
      color: #2c3e50;
      font-weight: 600;
      margin: 5px 0;
    }
    .badge { 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 0.75em; 
      color: white; 
      display: inline-block; 
      margin: 2px 0;
    }
    .bg-group { background: #8e44ad; }
    .bg-market { background: #e67e22; }
    .bg-feed { background: #3498db; }
    .bg-keyword { background: #27ae60; }
    
    .stats-box {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      flex: 1;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-item .number {
      font-size: 2em;
      font-weight: bold;
    }
    .stat-item .label {
      font-size: 0.85em;
      opacity: 0.9;
    }
    
    .quick-links {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .quick-link {
      flex: 1;
      padding: 10px;
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.85em;
    }
    .quick-link:hover {
      border-color: #667eea;
      background: #e8f4f8;
    }
    
    #toast { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      padding: 15px 25px; 
      background: #333; 
      color: white; 
      border-radius: 8px; 
      display: none;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .help-text {
      font-size: 0.85em;
      color: #7f8c8d;
      margin-top: -10px;
      margin-bottom: 15px;
    }

    .mode-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .mode-tab {
      flex: 1;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }
    .mode-tab:hover {
      border-color: #667eea;
    }
    .mode-tab.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .mode-tab .icon { font-size: 1.5em; margin-bottom: 5px; }
    .mode-tab .title { font-weight: 600; }
    .mode-tab .desc { font-size: 0.8em; opacity: 0.8; }

    .mode-content { display: none; }
    .mode-content.active { display: block; }
  </style>
</head>
<body>

<div class="container">
  <h2>üïµÔ∏è Facebook Scraper</h2>
  <p class="subtitle">S·ª≠ d·ª•ng Network Interception ƒë·ªÉ c√†o d·ªØ li·ªáu t·ª´ Group, Marketplace, Newsfeed v√† Trang ch·ªß Facebook</p>
  
  <!-- ƒêƒÇNG NH·∫¨P -->
  <label>üìß Email Facebook:</label>
  <input id="email" placeholder="Nh·∫≠p email ƒë√£ ƒëƒÉng k√Ω Facebook..." />
  
  <button class="btn-login" onclick="doLogin()">üîê B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p & L∆∞u Cookie (30s)</button>
  
  <div class="section-divider"><span>CH·ªåN CH·∫æ ƒê·ªò C√ÄO</span></div>
  
  <!-- TABS CH·ªåN CH·∫æ ƒê·ªò -->
  <div class="mode-tabs">
    <div class="mode-tab active" onclick="switchMode('search')">
      <div class="icon">üîç</div>
      <div class="title">Search Mode</div>
      <div class="desc">T√¨m theo t·ª´ kh√≥a trong Group/Marketplace</div>
    </div>
    <div class="mode-tab" onclick="switchMode('feed')">
      <div class="icon">üì∞</div>
      <div class="title">Feed Mode</div>
      <div class="desc">C√†o Feed Group/Newsfeed + L·ªçc t·ª´ kh√≥a</div>
    </div>
  </div>

  <!-- MODE 1: SEARCH -->
  <div id="mode-search" class="mode-content active">
    <label>üîó Link Group ho·∫∑c Marketplace:</label>
    <input id="url" placeholder="VD: https://www.facebook.com/groups/123456 ho·∫∑c https://www.facebook.com/marketplace" />
    <p class="help-text">* Tool s·∫Ω t·ª± th√™m <b>/search/?q=...</b> ƒë·ªÉ t√¨m ki·∫øm theo t·ª´ kh√≥a</p>
    
    <label>üîë T·ª´ kh√≥a (M·ªói d√≤ng 1 t·ª´ kh√≥a):</label>
    <textarea id="keywords" rows="4" placeholder="iphone 15 pro max&#10;macbook m3&#10;samsung s24"></textarea>
    
    <button class="btn-search" onclick="doSearch()">üöÄ B∆∞·ªõc 2: Qu√©t theo Search</button>
  </div>

  <!-- MODE 2: FEED -->
  <div id="mode-feed" class="mode-content">
    <label>üîó Link Feed:</label>
    <input id="feedUrl" placeholder="VD: https://www.facebook.com/groups/123456" />
    
    <div class="quick-links">
      <div class="quick-link" onclick="setFeedUrl('https://www.facebook.com')">
        üè† Newsfeed c√° nh√¢n
      </div>
      <div class="quick-link" onclick="setFeedUrl('https://www.facebook.com/?ref=homescreenpwa')">
        üì± Trang ch·ªß (PWA)
      </div>
      <div class="quick-link" onclick="setFeedUrl('https://www.facebook.com/groups/feed')">
        üë• T·∫•t c·∫£ Groups
      </div>
    </div>
    <p class="help-text">* V√†o th·∫≥ng trang ch·ªß/Feed v√† cu·ªôn ƒë·ªÉ load b√†i vi·∫øt, sau ƒë√≥ l·ªçc theo t·ª´ kh√≥a b·∫°n nh·∫≠p</p>
    
    <label>üîë T·ª´ kh√≥a l·ªçc (M·ªói d√≤ng 1 t·ª´ kh√≥a):</label>
    <textarea id="feedKeywords" rows="4" placeholder="iphone 15 pro max&#10;macbook m3&#10;samsung s24"></textarea>
    
    <label>üìú S·ªë l·∫ßn cu·ªôn trang:</label>
    <select id="scrollCount">
      <option value="5">5 l·∫ßn (Nhanh - ~20 b√†i)</option>
      <option value="10" selected>10 l·∫ßn (V·ª´a - ~50 b√†i)</option>
      <option value="20">20 l·∫ßn (Nhi·ªÅu - ~100 b√†i)</option>
      <option value="30">30 l·∫ßn (R·∫•t nhi·ªÅu - ~150 b√†i)</option>
    </select>
    
    <button class="btn-feed" onclick="doScrapeFeed()">üì∞ B∆∞·ªõc 2: C√†o Feed + L·ªçc t·ª´ kh√≥a</button>
  </div>

  <!-- LOADING -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div><b>ƒêang ch·∫°y Chrome ng·∫ßm...</b></div>
    <div style="font-size:0.9em; color:#888; margin-top:5px;">
      Tool ƒëang b·∫Øt g√≥i tin JSON t·ª´ Facebook.<br/>
      Vui l√≤ng ƒë·ª£i 30-60 gi√¢y.
    </div>
  </div>
</div>

<!-- K·∫æT QU·∫¢ -->
<div id="results" class="container" style="display:none;">
  <h3 style="margin-top:0;">üìä K·∫øt qu·∫£</h3>
  
  <div class="stats-box">
    <div class="stat-item">
      <div class="number" id="statTotal">0</div>
      <div class="label">T·ªïng c√†o ƒë∆∞·ª£c</div>
    </div>
    <div class="stat-item">
      <div class="number" id="statMatched">0</div>
      <div class="label">Kh·ªõp t·ª´ kh√≥a</div>
    </div>
  </div>
  
  <p id="filePath" style="color:#7f8c8d; font-size:0.9em;"></p>
  
  <!-- N√∫t g·ª≠i v·ªÅ B√†i ƒëƒÉng -->
  <button id="sendToDashboard" class="btn-dashboard" onclick="sendDataToDashboard()" style="display:none;">
    üöÄ G·ª≠i d·ªØ li·ªáu v·ªÅ trang B√†i ƒëƒÉng
  </button>
  
  <table>
    <thead>
      <tr>
        <th width="120">·∫¢nh</th>
        <th>N·ªôi dung</th>
        <th width="140">Th√¥ng tin</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="toast"></div>

<script>
  // Toast notification
  function toast(msg, duration = 3000) {
    const t = document.getElementById("toast");
    t.innerText = msg; 
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", duration);
  }

  // Chuy·ªÉn tab mode
  function switchMode(mode) {
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
    
    document.querySelector(`.mode-tab:nth-child(${mode === 'search' ? 1 : 2})`).classList.add('active');
    document.getElementById(`mode-${mode}`).classList.add('active');
  }

  // Quick link cho Feed URL
  function setFeedUrl(url) {
    document.getElementById("feedUrl").value = url;
    toast("ƒê√£ ch·ªçn: " + url);
  }

  // ƒêƒÉng nh·∫≠p
  async function doLogin() {
    const email = document.getElementById("email").value;
    if(!email) return toast("Ch∆∞a nh·∫≠p email!");
    
    document.getElementById("loading").style.display = "block";
    toast("ƒêang m·ªü Chrome... H√£y ƒëƒÉng nh·∫≠p trong 30 gi√¢y!", 5000);
    
    try {
      const res = await fetch("/api/init-login", {
        method: "POST", 
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({email})
      });
      const d = await res.json();
      toast(d.ok ? "‚úÖ " + d.message : "‚ùå " + d.error, 5000);
    } catch(e) { 
      toast("‚ùå L·ªói: " + e); 
    }
    document.getElementById("loading").style.display = "none";
  }

  // Search Mode
  async function doSearch() {
    const email = document.getElementById("email").value;
    const url = document.getElementById("url").value;
    const kws = document.getElementById("keywords").value;

    if(!email || !url || !kws) return toast("Thi·∫øu th√¥ng tin!");

    document.getElementById("loading").style.display = "block";
    document.getElementById("results").style.display = "none";

    try {
      const res = await fetch("/api/scrape-filter", {
        method: "POST", 
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, url, keywordsText: kws })
      });
      const d = await res.json();
      
      if(!d.ok) {
        toast("‚ùå " + d.error);
        document.getElementById("loading").style.display = "none";
        return;
      }

      displayResults(d.matched, d.totalItems || d.matched.length, d.file);
    } catch(e) { 
      toast("‚ùå L·ªói h·ªá th·ªëng: " + e); 
    }
    
    document.getElementById("loading").style.display = "none";
  }

  // Feed Mode
  async function doScrapeFeed() {
    const email = document.getElementById("email").value;
    const feedUrl = document.getElementById("feedUrl").value;
    const kws = document.getElementById("feedKeywords").value;
    const scrollCount = parseInt(document.getElementById("scrollCount").value) || 10;

    if(!email || !feedUrl || !kws) return toast("Thi·∫øu th√¥ng tin!");

    document.getElementById("loading").style.display = "block";
    document.getElementById("results").style.display = "none";

    try {
      const res = await fetch("/api/scrape-feed", {
        method: "POST", 
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, feedUrl, keywordsText: kws, scrollCount })
      });
      const d = await res.json();
      
      if(!d.ok) {
        toast("‚ùå " + d.error);
        document.getElementById("loading").style.display = "none";
        return;
      }

      displayResults(d.matched, d.totalScraped || 0, d.file);
    } catch(e) { 
      toast("‚ùå L·ªói h·ªá th·ªëng: " + e); 
    }
    
    document.getElementById("loading").style.display = "none";
  }

  // L∆∞u d·ªØ li·ªáu ƒë√£ c√†o ƒë·ªÉ g·ª≠i v·ªÅ SalesDashboard
  let lastScrapedData = null;
  let lastTotalScraped = 0;

  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  function displayResults(items, totalScraped, fileName) {
    // L∆∞u l·∫°i d·ªØ li·ªáu
    lastScrapedData = items;
    lastTotalScraped = totalScraped;

    document.getElementById("statTotal").innerText = totalScraped;
    document.getElementById("statMatched").innerText = items.length;
    document.getElementById("filePath").innerText = "üìÅ File: " + fileName;
    
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:30px;">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o kh·ªõp t·ª´ kh√≥a</td></tr>';
    } else {
      items.forEach(item => {
        let typeBadge = '<span class="badge bg-group">Group</span>';
        if (item.type === 'marketplace') {
          typeBadge = '<span class="badge bg-market">Marketplace</span>';
        } else if (item.type === 'newsfeed') {
          typeBadge = '<span class="badge bg-feed">Newsfeed</span>';
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <img src="${item.image || ''}" class="thumb" onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'"/>
          </td>
          <td>
            ${typeBadge}
            <a href="${item.url}" target="_blank" style="font-weight:bold; text-decoration:none; color:#2c3e50; font-size:1.05em; display:block; margin:5px 0;">
              ${escapeHtml(item.title)}
            </a>
            <div style="font-size:0.9em; color:#555; max-height:100px; overflow:hidden; line-height:1.4;">
              ${escapeHtml(item.fullText).substring(0, 300)}${item.fullText.length > 300 ? '...' : ''}
            </div>
            <div style="margin-top:8px;">
              <span class="badge bg-keyword">üîë ${escapeHtml(item.keyword)}</span>
            </div>
          </td>
          <td>
            <div class="price">${escapeHtml(item.price) || '‚Äî'}</div>
            ${item.author ? `<div class="author">üë§ ${escapeHtml(item.author)}</div>` : ''}
            ${item.uid ? `<div style="font-size:0.8em; color:#7f8c8d;">ID: ${item.uid}</div>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("results").style.display = "block";
    // Hi·ªán n√∫t g·ª≠i v·ªÅ Dashboard
    document.getElementById("sendToDashboard").style.display = "block";
    document.getElementById("results").scrollIntoView({ behavior: 'smooth' });
    toast(`‚úÖ T√¨m th·∫•y ${items.length} b√†i vi·∫øt!`);
  }

  // URL Backend API
  const BACKEND_API = 'http://localhost:5000/api';

  // G·ª≠i d·ªØ li·ªáu v·ªÅ Backend v√† Dashboard
  async function sendDataToDashboard() {
    if (!lastScrapedData || lastScrapedData.length === 0) {
      toast("‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ g·ª≠i!");
      return;
    }

    toast("‚è≥ ƒêang g·ª≠i d·ªØ li·ªáu l√™n server...", 3000);

    try {
      console.log(`üì§ Sending ${lastScrapedData.length} items to ${BACKEND_API}/posts`);
      
      // 1. G·ª¨I D·ªÆ LI·ªÜU L√äN BACKEND API (l∆∞u v√†o database)
      const response = await fetch(`${BACKEND_API}/posts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: lastScrapedData })
      });

      console.log('üì• Response status:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      console.log('üì• API Response:', result);

      if (result.success) {
        toast(`‚úÖ ${result.message}`, 5000);
        if (result.added > 0) {
          console.log(`‚úÖ Successfully added ${result.added} posts to database`);
        }
        if (result.duplicates > 0) {
          console.log(`‚ö†Ô∏è Skipped ${result.duplicates} duplicate posts`);
        }
      } else {
        toast(`‚ö†Ô∏è API Error: ${result.message}`, 5000);
        console.error('API Error:', result);
      }
    } catch (err) {
      console.error('‚ùå API Error:', err);
      toast(`‚ö†Ô∏è L·ªói: ${err.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server'}`, 5000);
    }

    // 2. L∆ØU V√ÄO LOCALSTORAGE (backup)
    const dataToSend = {
      items: lastScrapedData,
      totalScraped: lastTotalScraped,
      timestamp: Date.now()
    };
    localStorage.setItem('scraperData', JSON.stringify(dataToSend));

    // 3. G·ª¨I QUA POSTMESSAGE n·∫øu ƒë∆∞·ª£c m·ªü t·ª´ popup
    if (window.opener) {
      window.opener.postMessage({
        type: 'SCRAPER_DATA',
        data: dataToSend
      }, '*');
      toast("‚úÖ ƒê√£ g·ª≠i d·ªØ li·ªáu! ƒêang ƒë√≥ng c·ª≠a s·ªï...", 2000);
      setTimeout(() => window.close(), 2000);
    } else {
      // Chuy·ªÉn h∆∞·ªõng v·ªÅ dashboard
      toast("‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu! ƒêang chuy·ªÉn v·ªÅ Dashboard...", 2000);
      setTimeout(() => {
        window.location.href = 'http://localhost:3000';
      }, 2000);
    }
  }

  // Escape HTML ƒë·ªÉ tr√°nh XSS
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
